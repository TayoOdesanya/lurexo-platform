name: Deploy Frontend (Next.js) to Azure Web App

on:
  push:
    branches: ["azuredeploy"]
    paths:
      - "frontend/**"
      - ".github/workflows/deploy-frontend.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          # Your lockfile lives at repo root (monorepo/workspaces), so cache that
          cache: "npm"
          cache-dependency-path: package-lock.json

      # IMPORTANT: install from repo root so the workspace/hoisted deps (incl next) exist
      - name: Install dependencies (repo root)
        run: npm install --no-audit --no-fund

      - name: Verify root node_modules exists
        run: |
          test -d node_modules || (echo "node_modules not found at repo root" && exit 1)

      - name: Build (frontend)
        working-directory: frontend
        run: npm run build

      - name: Verify standalone build output
        working-directory: frontend
        run: |
          test -d .next/standalone || (echo ".next/standalone not found. Ensure next.config.ts has: output: 'standalone'" && exit 1)
          test -f .next/standalone/server.js || (echo "server.js not found in .next/standalone" && exit 1)
          echo "Standalone output OK"
          ls -la .next/standalone | head

      # Package: standalone server.js at zip root + static assets + PUBLIC + ROOT node_modules (so require('next') works)
      - name: Create deployment zip (standalone + root node_modules)
        run: |
          rm -f frontend.zip
          rm -rf _deploy
          mkdir -p _deploy

          # Copy standalone server output to deploy root (puts server.js at /home/site/wwwroot/server.js)
          cp -R frontend/.next/standalone/* _deploy/

          # Next runtime expects static at .next/static
          mkdir -p _deploy/.next
          cp -R frontend/.next/static _deploy/.next/static

          # Public assets
          if [ -d "frontend/public" ]; then
            cp -R frontend/public _deploy/public
          fi

          # Hoisted/workspace deps (includes next) â€” REQUIRED for server.js require('next')
          cp -R node_modules _deploy/node_modules

          # Create zip from the CONTENTS of _deploy (not the folder)
          cd _deploy
          zip -r ../frontend.zip .
          cd ..

          ls -lh frontend.zip
          unzip -l frontend.zip | head -n 60

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: lurexo-web
          package: frontend.zip
