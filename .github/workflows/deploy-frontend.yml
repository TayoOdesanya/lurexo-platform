name: Deploy Frontend (Next.js) to Azure Web App

on:
  push:
    branches: ["azuredeploy"]
    paths:
      - "frontend/**"
      - ".github/workflows/deploy-frontend.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Don't enable npm cache unless frontend/package-lock.json exists.
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies (frontend)
        working-directory: frontend
        run: npm install --no-audit --no-fund

      - name: Build (frontend)
        working-directory: frontend
        run: npm run build

      - name: Verify standalone build output (find server.js)
        run: |
          test -d frontend/.next/standalone || (echo "frontend/.next/standalone not found. Did you set output: 'standalone' in next.config.ts?" && exit 1)

          echo "Searching for server.js under frontend/.next/standalone..."
          find frontend/.next/standalone -maxdepth 8 -name server.js -print

          SERVER_JS_PATH="$(find frontend/.next/standalone -maxdepth 8 -name server.js -print -quit)"
          test -n "$SERVER_JS_PATH" || (echo "server.js not found anywhere under frontend/.next/standalone" && exit 1)

          SERVER_DIR="$(dirname "$SERVER_JS_PATH")"

          echo "Found server.js at: $SERVER_JS_PATH"
          echo "SERVER_DIR=$SERVER_DIR" >> $GITHUB_ENV

      # Package standalone so server.js ends up at /home/site/wwwroot/server.js
      - name: Create deployment zip (standalone)
        run: |
          rm -f frontend.zip
          rm -rf _deploy
          mkdir -p _deploy

          echo "Using SERVER_DIR=$SERVER_DIR"
          test -d "$SERVER_DIR" || (echo "SERVER_DIR does not exist: $SERVER_DIR" && exit 1)

          # Copy the folder that contains server.js to the deploy root
          cp -R "$SERVER_DIR"/* _deploy/

          # Copy static assets where Next expects them at runtime
          mkdir -p _deploy/.next
          cp -R frontend/.next/static _deploy/.next/static

          # Public assets
          if [ -d "frontend/public" ]; then
            cp -R frontend/public _deploy/public
          fi

          # Sanity check: server.js must exist at deploy root
          test -f _deploy/server.js || (echo "Expected _deploy/server.js but not found after copy" && exit 1)

          # Zip the contents of _deploy so server.js is at zip root
          cd _deploy
          zip -r ../frontend.zip .
          cd ..

          echo "Zip created:"
          ls -lh frontend.zip
          echo "Zip contents (top):"
          unzip -l frontend.zip | head -n 80

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: lurexo-web
          package: frontend.zip
