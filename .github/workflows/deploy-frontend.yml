name: Deploy Frontend (Next.js) to Azure Web App

on:
  push:
    branches: ["azuredeploy"]
    paths:
      - "frontend/**"
      - ".github/workflows/deploy-frontend.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: lurexo-web-frontend
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      # Install deps at repo root (monorepo layout)
      - name: Install dependencies (repo root)
        run: npm install --no-audit --no-fund

      - name: Build (frontend)
        working-directory: frontend
        env:
          # Build-time env (baked into client bundles)
          NEXT_PUBLIC_API_BASE_URL: ${{ vars.NEXT_PUBLIC_API_BASE_URL }}
          NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}
        run: npm run build

      - name: Create deployment zip (Next.js standalone)
        run: |
          set -e

          rm -f frontend.zip
          rm -rf _deploy
          mkdir -p _deploy

          STANDALONE_ROOT="frontend/.next/standalone"
          test -d "$STANDALONE_ROOT" || (echo "Missing $STANDALONE_ROOT â€” ensure next.config.ts has output: 'standalone'" && exit 1)

          SERVER_JS="$(find "$STANDALONE_ROOT" -type f -name server.js | head -n 1)"
          test -n "$SERVER_JS" || (echo "server.js not found under $STANDALONE_ROOT" && exit 1)

          SERVER_DIR="$(dirname "$SERVER_JS")"

          echo "Standalone root: $STANDALONE_ROOT"
          echo "Server.js found at: $SERVER_JS"
          echo "Server dir: $SERVER_DIR"

          # Copy app bundle so server.js is at zip root
          cp -R "$SERVER_DIR/"* _deploy/

          # Copy standalone node_modules (preferred location)
          if [ -d "$STANDALONE_ROOT/node_modules" ]; then
            cp -R "$STANDALONE_ROOT/node_modules" _deploy/node_modules
          elif [ -d "$SERVER_DIR/node_modules" ]; then
            cp -R "$SERVER_DIR/node_modules" _deploy/node_modules
          else
            echo "No node_modules found in standalone output"
            echo "Standalone dirs (top):"
            find "$STANDALONE_ROOT" -maxdepth 3 -type d | sed -n '1,200p'
            exit 1
          fi

          # Static assets
          mkdir -p _deploy/.next
          cp -R frontend/.next/static _deploy/.next/static

          # Public assets
          if [ -d "frontend/public" ]; then
            cp -R frontend/public _deploy/public
          fi

          # Sanity checks
          test -f _deploy/server.js || (echo "server.js missing at deploy root" && exit 1)
          test -d _deploy/node_modules || (echo "node_modules missing at deploy root" && exit 1)

          cd _deploy
          zip -r ../frontend.zip .
          cd ..

          ls -lh frontend.zip
          unzip -l frontend.zip | head -n 120

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Avoid SCM restart collision
      - name: Wait for SCM to settle
        run: sleep 30

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: lurexo-web
          package: frontend.zip
