// Lurexo Platform - Complete Prisma Schema
// Database: PostgreSQL 15+
// ORM: Prisma 6.17.1

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

enum UserRole {
  BUYER
  ORGANIZER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

model User {
  id                String      @id @default(uuid())
  email             String      @unique
  passwordHash      String      @map("password_hash")
  role              UserRole    @default(BUYER)
  status            UserStatus  @default(ACTIVE)
  
  // Profile
  firstName         String?     @map("first_name")
  lastName          String?     @map("last_name")
  phoneNumber       String?     @map("phone_number")
  dateOfBirth       DateTime?   @map("date_of_birth") @db.Date
  profilePicture    String?     @map("profile_picture")
  
  // Verification
  emailVerified     Boolean     @default(false) @map("email_verified")
  emailVerifiedAt   DateTime?   @map("email_verified_at")
  verificationToken String?     @unique @map("verification_token")
  
  // Password Reset
  resetToken        String?     @unique @map("reset_token")
  resetTokenExpiry  DateTime?   @map("reset_token_expiry")
  
  // Timestamps
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  lastLoginAt       DateTime?   @map("last_login_at")
  
  // Relations
  organizedEvents   Event[]     @relation("OrganizerEvents")
  orders            Order[]     @relation("BuyerOrders")
  tickets           Ticket[]    @relation("TicketOwner")
  sentTransfers     TicketTransfer[] @relation("TransferSender")
  receivedTransfers TicketTransfer[] @relation("TransferReceiver")
  listings          TicketListing[] @relation("ListingSeller")
  purchases         TicketListing[] @relation("ListingBuyer")
  bankAccounts      BankAccount[]
  payouts           Payout[]
  
  @@map("users")
}

// ============================================
// EVENT MANAGEMENT
// ============================================

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum EventCategory {
  MUSIC
  SPORTS
  ARTS
  COMEDY
  THEATER
  CONFERENCE
  OTHER
}

model Event {
  id                String        @id @default(uuid())
  organizerId       String        @map("organizer_id")
  
  // Basic Info
  title             String
  slug              String        @unique
  description       String        @db.Text
  category          EventCategory
  status            EventStatus   @default(DRAFT)
  
  // Images
  heroImage         String        @map("hero_image")
  galleryImages     String[]      @map("gallery_images")
  
  // Location
  venue             String
  address           String
  city              String
  country           String        @default("United Kingdom")
  postalCode        String        @map("postal_code")
  latitude          Decimal?      @db.Decimal(10, 8)
  longitude         Decimal?      @db.Decimal(11, 8)
  
  // Date & Time
  eventDate         DateTime      @map("event_date")
  doorsOpen         DateTime?     @map("doors_open")
  eventEnd          DateTime?     @map("event_end")
  timezone          String        @default("Europe/London")
  
  // Sales Configuration
  saleStartDate     DateTime      @map("sale_start_date")
  saleEndDate       DateTime      @map("sale_end_date")
  maxTicketsPerOrder Int          @default(10) @map("max_tickets_per_order")
  
  // Capacity & Sales
  totalCapacity     Int           @map("total_capacity")
  ticketsSold       Int           @default(0) @map("tickets_sold")
  
  // Revenue Tracking (in pence)
  totalRevenue      Int           @default(0) @map("total_revenue")
  organizerRevenue  Int           @default(0) @map("organizer_revenue")
  platformRevenue   Int           @default(0) @map("platform_revenue")
  
  // Timestamps
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  publishedAt       DateTime?     @map("published_at")
  
  // Relations
  organizer         User          @relation("OrganizerEvents", fields: [organizerId], references: [id], onDelete: Cascade)
  ticketTiers       TicketTier[]
  orders            Order[]
  tickets           Ticket[]
  listings          TicketListing[]
  
  @@index([organizerId])
  @@index([status, eventDate])
  @@index([category, eventDate])
  @@index([slug])
  @@map("events")
}

// ============================================
// TICKET TIERS
// ============================================

enum TierStatus {
  ACTIVE
  SOLD_OUT
  HIDDEN
}

model TicketTier {
  id                String      @id @default(uuid())
  eventId           String      @map("event_id")
  
  // Tier Details
  name              String
  description       String?     @db.Text
  price             Int         // Price in pence
  quantity          Int
  quantitySold      Int         @default(0) @map("quantity_sold")
  
  // Sales Configuration
  status            TierStatus  @default(ACTIVE)
  maxPerOrder       Int         @default(10) @map("max_per_order")
  saleStartDate     DateTime?   @map("sale_start_date")
  saleEndDate       DateTime?   @map("sale_end_date")
  
  // Display
  displayOrder      Int         @default(0) @map("display_order")
  
  // Timestamps
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  
  // Relations
  event             Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tickets           Ticket[]
  
  @@index([eventId])
  @@map("ticket_tiers")
}

// ============================================
// ORDERS & TICKETS
// ============================================

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

model Order {
  id                String      @id @default(uuid())
  userId            String      @map("user_id")
  eventId           String      @map("event_id")
  
  // Order Details
  orderNumber       String      @unique @map("order_number")
  status            OrderStatus @default(PENDING)
  
  // Pricing (in pence)
  subtotal          Int         // Sum of ticket prices
  serviceFee        Int         @map("service_fee") // 4% fee
  totalAmount       Int         @map("total_amount")
  
  // Payment
  stripePaymentIntentId String? @unique @map("stripe_payment_intent_id")
  stripeChargeId    String?     @unique @map("stripe_charge_id")
  paymentMethod     String?     @map("payment_method") // card, apple_pay, google_pay
  
  // Buyer Information
  buyerEmail        String      @map("buyer_email")
  buyerFirstName    String      @map("buyer_first_name")
  buyerLastName     String      @map("buyer_last_name")
  
  // Timestamps
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  completedAt       DateTime?   @map("completed_at")
  
  // Relations
  user              User        @relation("BuyerOrders", fields: [userId], references: [id], onDelete: Cascade)
  event             Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tickets           Ticket[]
  
  @@index([userId])
  @@index([eventId])
  @@index([status])
  @@index([orderNumber])
  @@map("orders")
}

enum TicketStatus {
  VALID
  USED
  CANCELLED
  TRANSFERRED
  LISTED_FOR_SALE
}

model Ticket {
  id                String        @id @default(uuid())
  orderId           String        @map("order_id")
  eventId           String        @map("event_id")
  tierId            String        @map("tier_id")
  currentOwnerId    String        @map("current_owner_id")
  originalOwnerId   String        @map("original_owner_id")
  
  // Ticket Details
  ticketNumber      String        @unique @map("ticket_number")
  qrCode            String        @unique @map("qr_code") // JWT token
  status            TicketStatus  @default(VALID)
  
  // Pricing (in pence)
  faceValue         Int           @map("face_value")
  pricePaid         Int           @map("price_paid") // Including fees
  
  // Usage
  scannedAt         DateTime?     @map("scanned_at")
  scannedBy         String?       @map("scanned_by")
  
  // Timestamps
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  
  // Relations
  order             Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  event             Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tier              TicketTier    @relation(fields: [tierId], references: [id], onDelete: Cascade)
  currentOwner      User          @relation("TicketOwner", fields: [currentOwnerId], references: [id], onDelete: Cascade)
  transfers         TicketTransfer[]
  listings          TicketListing[]
  
  @@index([orderId])
  @@index([eventId])
  @@index([currentOwnerId])
  @@index([status])
  @@index([ticketNumber])
  @@map("tickets")
}

// ============================================
// TICKET TRANSFERS (FREE)
// ============================================

enum TransferStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
  CANCELLED
}

model TicketTransfer {
  id                String         @id @default(uuid())
  ticketId          String         @map("ticket_id")
  senderId          String         @map("sender_id")
  receiverId        String?        @map("receiver_id")
  
  // Transfer Details
  recipientEmail    String         @map("recipient_email")
  transferToken     String         @unique @map("transfer_token")
  status            TransferStatus @default(PENDING)
  message           String?        @db.Text
  
  // Timestamps
  createdAt         DateTime       @default(now()) @map("created_at")
  expiresAt         DateTime       @map("expires_at")
  acceptedAt        DateTime?      @map("accepted_at")
  
  // Relations
  ticket            Ticket         @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender            User           @relation("TransferSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver          User?          @relation("TransferReceiver", fields: [receiverId], references: [id])
  
  @@index([ticketId])
  @@index([senderId])
  @@index([recipientEmail])
  @@index([transferToken])
  @@map("ticket_transfers")
}

// ============================================
// TICKET RESALE MARKETPLACE
// ============================================

enum ListingStatus {
  ACTIVE
  SOLD
  CANCELLED
  EXPIRED
}

model TicketListing {
  id                String        @id @default(uuid())
  ticketId          String        @unique @map("ticket_id") // One ticket, one listing
  sellerId          String        @map("seller_id")
  buyerId           String?       @map("buyer_id")
  eventId           String        @map("event_id")
  
  // Pricing (in pence)
  originalPrice     Int           @map("original_price")
  listingPrice      Int           @map("listing_price")
  serviceFee        Int           @map("service_fee") // 4% on resale
  
  // Listing Details
  status            ListingStatus @default(ACTIVE)
  
  // Payment
  stripePaymentIntentId String?   @unique @map("stripe_payment_intent_id")
  
  // Timestamps
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  soldAt            DateTime?     @map("sold_at")
  
  // Relations
  ticket            Ticket        @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  seller            User          @relation("ListingSeller", fields: [sellerId], references: [id], onDelete: Cascade)
  buyer             User?         @relation("ListingBuyer", fields: [buyerId], references: [id])
  event             Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  @@index([sellerId])
  @@index([eventId])
  @@index([status])
  @@map("ticket_listings")
}

// ============================================
// ORGANIZER PAYOUTS
// ============================================

model BankAccount {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  
  // Stripe Connected Account
  stripeAccountId   String   @unique @map("stripe_account_id")
  accountStatus     String   @map("account_status") // pending, active, restricted
  
  // Bank Details (encrypted/tokenized by Stripe)
  accountHolderName String   @map("account_holder_name")
  last4             String   // Last 4 digits
  bankName          String?  @map("bank_name")
  
  // Verification
  verified          Boolean  @default(false)
  verifiedAt        DateTime? @map("verified_at")
  
  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  payouts           Payout[]
  
  @@index([userId])
  @@map("bank_accounts")
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model Payout {
  id                String       @id @default(uuid())
  userId            String       @map("user_id")
  bankAccountId     String       @map("bank_account_id")
  
  // Payout Details
  amount            Int          // Amount in pence
  currency          String       @default("GBP")
  status            PayoutStatus @default(PENDING)
  
  // Stripe
  stripePayoutId    String?      @unique @map("stripe_payout_id")
  stripeTransferId  String?      @unique @map("stripe_transfer_id")
  
  // Metadata
  description       String?      @db.Text
  failureReason     String?      @map("failure_reason")
  
  // Timestamps
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")
  processedAt       DateTime?    @map("processed_at")
  
  // Relations
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankAccount       BankAccount  @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
  @@map("payouts")
}
