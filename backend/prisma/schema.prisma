generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String             @id @default(uuid())
  email                  String             @unique
  passwordHash           String             @map("password_hash")
  role                   UserRole           @default(BUYER)
  status                 UserStatus         @default(ACTIVE)
  firstName              String?            @map("first_name")
  lastName               String?            @map("last_name")
  phoneNumber            String?            @map("phone_number")
  dateOfBirth            DateTime?          @map("date_of_birth") @db.Date
  profilePicture         String?            @map("profile_picture")
  emailVerified          Boolean            @default(false) @map("email_verified")
  emailVerifiedAt        DateTime?          @map("email_verified_at")
  verificationToken      String?            @unique @map("verification_token")
  resetToken             String?            @unique @map("reset_token")
  resetTokenExpiry       DateTime?          @map("reset_token_expiry")
  createdAt              DateTime           @default(now()) @map("created_at")
  updatedAt              DateTime           @updatedAt @map("updated_at")
  lastLoginAt            DateTime?          @map("last_login_at")
  organizerAvatar        String?
  organizerId            String?
  organizerName          String?
  organizerUsername      String?
  organizerVerified      Boolean            @default(false)
  organizerBio           String?            @map("organizer_bio")
  organizerCompanyName   String?            @map("organizer_company_name")
  organizerWebsite       String?            @map("organizer_website")
  organizerAddress       String?            @map("organizer_address")
  organizerVatNumber     String?            @map("organizer_vat_number")
  avatar                 String?
  username               String?            @unique
  verified               Boolean            @default(false)
  bankAccounts           BankAccount[]
  organizerCollaborators Collaborator[]     @relation("OrganizerCollaborators")
  collaborators          Collaborator[]     @relation("UserCollaborators")
  organizedEvents        Event[]            @relation("OrganizerEvents")
  fanSubscriptions       FanSubscription[]
  marketingAccounts      MarketingAccount[]
  orders                 Order[]            @relation("BuyerOrders")
  payouts                Payout[]
  purchases              TicketListing[]    @relation("ListingBuyer")
  sellerListings         TicketListing[]    @relation("SellerListings")
  receivedTransfers      TicketTransfer[]   @relation("TransferReceiver")
  sentTransfers          TicketTransfer[]   @relation("TransferSender")
  tickets                Ticket[]           @relation("TicketOwner")

  @@map("users")
}

model Event {
  id                 String          @id @default(uuid())
  organizerId        String          @map("organizer_id")
  title              String
  slug               String          @unique
  description        String
  category           EventCategory
  status             EventStatus     @default(DRAFT)
  heroImage          String          @map("hero_image")
  galleryImages      String[]        @map("gallery_images")
  venue              String
  address            String
  city               String
  country            String          @default("United Kingdom")
  postalCode         String          @map("postal_code")
  latitude           Decimal?        @db.Decimal(10, 8)
  longitude          Decimal?        @db.Decimal(11, 8)
  eventDate          DateTime        @map("event_date")
  doorsOpen          DateTime?       @map("doors_open")
  eventEnd           DateTime?       @map("event_end")
  timezone           String          @default("Europe/London")
  saleStartDate      DateTime        @map("sale_start_date")
  saleEndDate        DateTime        @map("sale_end_date")
  maxTicketsPerOrder Int             @default(10) @map("max_tickets_per_order")
  totalCapacity      Int             @map("total_capacity")
  ticketsSold        Int             @default(0) @map("tickets_sold")
  totalRevenue       Int             @default(0) @map("total_revenue")
  organizerRevenue   Int             @default(0) @map("organizer_revenue")
  platformRevenue    Int             @default(0) @map("platform_revenue")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  publishedAt        DateTime?       @map("published_at")
  allowResale        Boolean         @default(true)
  resaleCapType      ResaleCapType   @default(PERCENTAGE_CAP)
  resaleCapValue     Int?            @default(110)
  organizer          User            @relation("OrganizerEvents", fields: [organizerId], references: [id], onDelete: Cascade)
  orders             Order[]
  paymentSplits      PaymentSplit[]
  listings           TicketListing[]
  ticketTiers        TicketTier[]
  tickets            Ticket[]
  guestListEntries   GuestListEntry[]

  @@index([organizerId])
  @@index([status, eventDate])
  @@index([category, eventDate])
  @@index([slug])
  @@map("events")
}

model GuestListEntry {
  id        String          @id @default(uuid())
  eventId   String          @map("event_id")
  name      String
  email     String?
  phone     String?
  notes     String?
  status    GuestListStatus @default(INVITED)
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")
  event     Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("guest_list_entries")
}

model Collaborator {
  id              String             @id @default(uuid())
  userId          String
  organizerId     String
  role            CollaboratorRole
  status          CollaboratorStatus @default(PENDING)
  has2FA          Boolean            @default(false)
  assignedEvents  String[]
  tempAccessStart DateTime?
  tempAccessEnd   DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  organizer       User               @relation("OrganizerCollaborators", fields: [organizerId], references: [id])
  user            User               @relation("UserCollaborators", fields: [userId], references: [id])
  paymentSplits   PaymentSplit[]
  permissions     Permission[]

  @@unique([userId, organizerId])
  @@map("collaborators")
}

model Permission {
  id             String       @id @default(uuid())
  collaboratorId String
  manageEvents   Boolean      @default(false)
  viewAnalytics  Boolean      @default(false)
  manageSales    Boolean      @default(false)
  accessDoor     Boolean      @default(false)
  sendMarketing  Boolean      @default(false)
  manageTeam     Boolean      @default(false)
  collaborator   Collaborator @relation(fields: [collaboratorId], references: [id])

  @@map("permissions")
}

model PaymentSplit {
  id             String       @id @default(uuid())
  collaboratorId String
  eventId        String
  percentage     Int
  enabled        Boolean      @default(true)
  createdAt      DateTime     @default(now())
  collaborator   Collaborator @relation(fields: [collaboratorId], references: [id])
  event          Event        @relation(fields: [eventId], references: [id])

  @@map("payment_splits")
}

model MarketingAccount {
  id          String      @id @default(uuid())
  userId      String
  accountType ProfileType
  fanCount    Int         @default(0)
  createdAt   DateTime    @default(now())
  campaigns   Campaign[]
  user        User        @relation(fields: [userId], references: [id])

  @@map("marketing_accounts")
}

model Campaign {
  id           String             @id @default(uuid())
  accountId    String
  name         String
  type         CampaignType
  subject      String
  content      String
  smsContent   String?
  segmentId    String?
  status       CampaignStatus     @default(DRAFT)
  scheduledFor DateTime?
  sentAt       DateTime?
  createdAt    DateTime           @default(now())
  analytics    CampaignAnalytics?
  account      MarketingAccount   @relation(fields: [accountId], references: [id])

  @@map("campaigns")
}

model FanSubscription {
  id             String      @id @default(uuid())
  fanId          String
  entityId       String
  entityType     ProfileType
  email          Boolean     @default(true)
  sms            Boolean     @default(false)
  source         String
  subscribedAt   DateTime    @default(now())
  unsubscribedAt DateTime?
  fan            User        @relation(fields: [fanId], references: [id])

  @@unique([fanId, entityId, entityType])
  @@map("fan_subscriptions")
}

model CampaignAnalytics {
  id             String   @id @default(uuid())
  campaignId     String   @unique
  sent           Int      @default(0)
  delivered      Int      @default(0)
  opened         Int      @default(0)
  openRate       Float    @default(0)
  clicked        Int      @default(0)
  clickRate      Float    @default(0)
  converted      Int      @default(0)
  conversionRate Float    @default(0)
  revenue        Float    @default(0)
  unsubscribed   Int      @default(0)
  complained     Int      @default(0)
  bounced        Int      @default(0)
  campaign       Campaign @relation(fields: [campaignId], references: [id])

  @@map("campaign_analytics")
}

model TicketTier {
  id            String     @id @default(uuid())
  eventId       String     @map("event_id")
  name          String
  description   String?
  price         Int
  quantity      Int
  quantitySold  Int        @default(0) @map("quantity_sold")
  status        TierStatus @default(ACTIVE)
  maxPerOrder   Int        @default(10) @map("max_per_order")
  saleStartDate DateTime?  @map("sale_start_date")
  saleEndDate   DateTime?  @map("sale_end_date")
  displayOrder  Int        @default(0) @map("display_order")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  event         Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tickets       Ticket[]

  @@index([eventId])
  @@map("ticket_tiers")
}

model Order {
  id                    String      @id @default(uuid())
  userId                String      @map("user_id")
  eventId               String      @map("event_id")
  orderNumber           String      @unique @map("order_number")
  status                OrderStatus @default(PENDING)
  subtotal              Int
  serviceFee            Int         @map("service_fee")
  totalAmount           Int         @map("total_amount")
  stripePaymentIntentId String?     @unique @map("stripe_payment_intent_id")
  stripeChargeId        String?     @unique @map("stripe_charge_id")
  paymentMethod         String?     @map("payment_method")
  buyerEmail            String      @map("buyer_email")
  buyerFirstName        String      @map("buyer_first_name")
  buyerLastName         String      @map("buyer_last_name")
  createdAt             DateTime    @default(now()) @map("created_at")
  updatedAt             DateTime    @updatedAt @map("updated_at")
  completedAt           DateTime?   @map("completed_at")
  event                 Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user                  User        @relation("BuyerOrders", fields: [userId], references: [id], onDelete: Cascade)
  tickets               Ticket[]

  @@index([userId])
  @@index([eventId])
  @@index([status])
  @@index([orderNumber])
  @@map("orders")
}

model Ticket {
  id              String           @id @default(uuid())
  orderId         String           @map("order_id")
  eventId         String           @map("event_id")
  tierId          String           @map("tier_id")
  currentOwnerId  String           @map("current_owner_id")
  originalOwnerId String           @map("original_owner_id")
  ticketNumber    String           @unique @map("ticket_number")
  qrCode          String           @unique @map("qr_code")
  status          TicketStatus     @default(VALID)
  faceValue       Int              @map("face_value")
  pricePaid       Int              @map("price_paid")
  scannedAt       DateTime?        @map("scanned_at")
  scannedBy       String?          @map("scanned_by")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  listings        TicketListing?
  transfers       TicketTransfer[]
  currentOwner    User             @relation("TicketOwner", fields: [currentOwnerId], references: [id], onDelete: Cascade)
  event           Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  order           Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  tier            TicketTier       @relation(fields: [tierId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([eventId])
  @@index([currentOwnerId])
  @@index([status])
  @@index([ticketNumber])
  @@map("tickets")
}

model TicketTransfer {
  id             String         @id @default(uuid())
  ticketId       String         @map("ticket_id")
  senderId       String         @map("sender_id")
  receiverId     String?        @map("receiver_id")
  recipientEmail String         @map("recipient_email")
  transferToken  String         @unique @map("transfer_token")
  status         TransferStatus @default(PENDING)
  message        String?
  createdAt      DateTime       @default(now()) @map("created_at")
  expiresAt      DateTime       @map("expires_at")
  acceptedAt     DateTime?      @map("accepted_at")
  receiver       User?          @relation("TransferReceiver", fields: [receiverId], references: [id])
  sender         User           @relation("TransferSender", fields: [senderId], references: [id], onDelete: Cascade)
  ticket         Ticket         @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([senderId])
  @@index([recipientEmail])
  @@index([transferToken])
  @@map("ticket_transfers")
}

model TicketListing {
  id        String        @id @default(uuid())
  ticketId  String        @unique @map("ticket_id")
  sellerId  String        @map("seller_id")
  buyerId   String?       @map("buyer_id")
  eventId   String        @map("event_id")
  status    ListingStatus @default(ACTIVE)
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  soldAt    DateTime?     @map("sold_at")
  expiresAt DateTime?     @map("expires_at")
  price     Int
  buyer     User?         @relation("ListingBuyer", fields: [buyerId], references: [id])
  event     Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  seller    User          @relation("SellerListings", fields: [sellerId], references: [id])
  ticket    Ticket        @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([sellerId])
  @@index([ticketId])
  @@index([eventId])
  @@map("ticket_listings")
}

model BankAccount {
  id                String    @id @default(uuid())
  userId            String    @map("user_id")
  stripeAccountId   String    @unique @map("stripe_account_id")
  accountStatus     String    @map("account_status")
  accountHolderName String    @map("account_holder_name")
  last4             String
  bankName          String?   @map("bank_name")
  verified          Boolean   @default(false)
  verifiedAt        DateTime? @map("verified_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payouts           Payout[]

  @@index([userId])
  @@map("bank_accounts")
}

model Payout {
  id               String       @id @default(uuid())
  userId           String       @map("user_id")
  bankAccountId    String       @map("bank_account_id")
  amount           Int
  currency         String       @default("GBP")
  status           PayoutStatus @default(PENDING)
  stripePayoutId   String?      @unique @map("stripe_payout_id")
  stripeTransferId String?      @unique @map("stripe_transfer_id")
  description      String?
  failureReason    String?      @map("failure_reason")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  processedAt      DateTime?    @map("processed_at")
  bankAccount      BankAccount  @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("payouts")
}

enum UserRole {
  BUYER
  ORGANIZER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum ResaleCapType {
  FACE_VALUE_ONLY
  FACE_VALUE_PLUS_FEES
  PERCENTAGE_CAP
  NO_CAP
  CUSTOM
}

enum ListingStatus {
  ACTIVE
  SOLD
  CANCELLED
  EXPIRED
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum EventCategory {
  MUSIC
  SPORTS
  ARTS
  COMEDY
  THEATER
  CONFERENCE
  OTHER
}

enum GuestListStatus {
  INVITED
  CHECKED_IN
  CANCELLED
}

enum CollaboratorRole {
  ADMIN
  EVENT_MANAGER
  MARKETING_LEAD
  PROMOTER
  SECURITY
  STAFF
}

enum CollaboratorStatus {
  ACTIVE
  PENDING
  SUSPENDED
}

enum ProfileType {
  ARTIST
  ORGANIZER
}

enum CampaignType {
  NEW_SHOW
  EXCLUSIVE_ACCESS
  MERCH_DROP
  THANK_YOU
  INTIMATE_SHOWCASE
  LAST_CHANCE
  CUSTOM
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
}

enum TierStatus {
  ACTIVE
  SOLD_OUT
  HIDDEN
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum TicketStatus {
  VALID
  USED
  CANCELLED
  TRANSFERRED
  LISTED_FOR_SALE
}

enum TransferStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
  CANCELLED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}
